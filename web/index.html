<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Order Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg:#0b1020; --fg:#e5e7eb; --muted:#9ca3af; --card:#111827; --b:#20293a; --acc:#6366f1; --ok:#10b981; --bad:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:24px;font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#0a0f1e;color:var(--fg)}
    .wrap{max-width:1000px;margin:auto}
    .toolbar{display:grid;gap:12px;grid-template-columns:1fr auto}
    .input{padding:10px 12px;border:1px solid #2a3246;border-radius:10px;background:#0f1629;color:var(--fg)}
    .btn{padding:10px 14px;border:0;border-radius:10px;background:var(--acc);color:#fff;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:14px;padding:16px}
    .muted{color:var(--muted)}
    .space{height:14px}
    .head{display:flex;justify-content:space-between;gap:16px;align-items:center}
    .pill{padding:6px 10px;border:1px solid #2a3246;border-radius:999px;background:#0f1629;color:var(--muted);white-space:nowrap}
    .grid{display:grid;gap:14px;grid-template-columns:1fr 1fr}
    @media (max-width:820px){.grid{grid-template-columns:1fr}}
    h2,h3,h4{margin:0 0 8px 0;font-weight:700}
    .kv{display:grid;grid-template-columns:140px 1fr;gap:6px 10px}
    .kv div:nth-child(odd){color:var(--muted)}
    .section h4{margin-bottom:10px}
    .tbl{width:100%;border-collapse:collapse}
    .tbl th,.tbl td{padding:8px 10px;border-bottom:1px solid #1e2433}
    .tbl th{color:var(--muted);text-align:left;font-weight:600}
    .totals{display:flex;justify-content:flex-end;margin-top:10px}
    .totals .box{min-width:280px}
    .totals .row{display:flex;justify-content:space-between;padding:6px 0}
    .totals .row.total{border-top:1px solid #2a3246;margin-top:6px;padding-top:10px;font-weight:700}
    .switch{display:flex;gap:8px;align-items:center}
    pre{background:var(--bg);color:#cbd5e1;padding:12px;border-radius:10px;overflow:auto;margin:0}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h2>Order Viewer</h2>
      <p class="muted">Введите <code>order_uid</code> или <code>customer_id</code> нажмите «Найти».</p>

      <div class="toolbar">
        <input id="orderId" class="input" placeholder="например, b563feb7b2b84b6test" />
        <button id="btn" class="btn">Найти</button>
      </div>

      <div class="toolbar" style="margin-top:10px">
        <input id="customerId" class="input" placeholder="customer_id, напр. user-777" />
        <button id="btnCust" class="btn">Заказы клиента</button>
      </div>
    </div>

    <div class="space"></div>

    <div id="result" class="card">
      <div class="muted">— результат появится здесь —</div>
    </div>

    <div class="space"></div>

    <div class="card">
      <div class="switch">
        <input type="checkbox" id="raw" />
        <label for="raw" class="muted">Показать raw JSON</label>
      </div>
      <div id="rawBox" style="display:none; margin-top:10px">
        <pre id="rawOut">—</pre>
      </div>
    </div>
  </div>

  <script>
    const elResult = document.getElementById('result');
    const elRaw = document.getElementById('raw');
    const elRawBox = document.getElementById('rawBox');
    const elRawOut = document.getElementById('rawOut');
    const elBtn = document.getElementById('btn');
    const elInput = document.getElementById('orderId');

    const elBtnCust = document.getElementById('btnCust');
    const elCustomer = document.getElementById('customerId');

    elRaw.addEventListener('change', () => {
      elRawBox.style.display = elRaw.checked ? 'block' : 'none';
    });

    elBtn.addEventListener('click', search);
    elInput.addEventListener('keydown', e => { if (e.key === 'Enter') search(); });

    elBtnCust.addEventListener('click', searchCustomer);
    elCustomer.addEventListener('keydown', e => { if (e.key === 'Enter') searchCustomer(); });

    function esc(s){ return String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function fmtMoney(amount, cur){ try{ return new Intl.NumberFormat('ru-RU',{style:'currency',currency:cur||'USD'}).format(Number(amount||0)); }catch(_){ return String(amount); } }
    function fmtDate(s){ const d = new Date(s); return isNaN(d) ? esc(s) : d.toLocaleString(); }

    async function search(){
      const id = elInput.value.trim();
      if(!id){ elResult.innerHTML = '<span class="muted">Введите order_id</span>'; return; }

      elBtn.disabled = true;
      elResult.innerHTML = '<span class="muted">Загрузка…</span>';
      try{
        const res = await fetch(`/order/${encodeURIComponent(id)}`);
        const txt = await res.text();
        let data;
        try { data = JSON.parse(txt); } catch { data = null; }

        if(!res.ok || !data || data.error){
          elResult.innerHTML = `<span class="muted">Ошибка: ${esc(data?.error || res.status + ' ' + res.statusText)}</span>`;
          elRawOut.textContent = txt;
          return;
        }
        elRawOut.textContent = JSON.stringify(data, null, 2);
        elResult.innerHTML = renderOrder(data);
      }catch(e){
        elResult.innerHTML = `<span class="muted">Ошибка запроса: ${esc(e)}</span>`;
      }finally{
        elBtn.disabled = false;
      }
    }

    async function searchCustomer(){
      const id = elCustomer.value.trim();
      if(!id){ elResult.innerHTML = '<span class="muted">Введите customer_id</span>'; return; }

      elBtnCust.disabled = true;
      elResult.innerHTML = '<span class="muted">Загрузка…</span>';
      try{
        const res = await fetch(`/customer/${encodeURIComponent(id)}/orders?limit=20`);
        const txt = await res.text();
        let data; try { data = JSON.parse(txt); } catch { data = null; }

        if(!res.ok || !Array.isArray(data)){
          elResult.innerHTML = `<span class="muted">Ошибка: ${esc(res.status + ' ' + res.statusText)}</span>`;
          elRawOut.textContent = txt;
          return;
        }

        elRawOut.textContent = JSON.stringify(data, null, 2);
        elResult.innerHTML = renderOrdersList(id, data);
      }catch(e){
        elResult.innerHTML = `<span class="muted">Ошибка запроса: ${esc(e)}</span>`;
      }finally{
        elBtnCust.disabled = false;
      }
    }

    function renderOrdersList(customerId, arr){
      if(!arr.length){
        return `<div class="muted">У клиента <span class="pill">${esc(customerId)}</span> нет заказов</div>`;
      }
      const head = `
        <div class="head">
          <div><h3 style="margin:0">Заказы клиента <span class="pill">${esc(customerId)}</span></h3></div>
          <div class="pill">Всего: ${arr.length}</div>
        </div>
        <div class="space"></div>
      `;
      return head + arr.map(renderOrder).join('<div class="space"></div>');
    }

    function renderOrder(o){
      const d = o.delivery || {};
      const p = o.payment || {};
      const items = Array.isArray(o.items) ? o.items : [];
      const itemsTotal = items.reduce((s, it) => s + Number(it.total_price || 0), 0);
      const deliveryCost = Number(p.delivery_cost || 0);
      const grand = itemsTotal + deliveryCost;

      const itemsRows = items.map(it => `
        <tr>
          <td>${esc(it.name)}</td>
          <td class="muted">${esc(it.brand || '')}</td>
          <td>${esc(it.track_number || '')}</td>
          <td>${esc(it.rid || '')}</td>
          <td style="text-align:right">${esc(it.sale ?? 0)}%</td>
          <td style="text-align:right">${fmtMoney(it.price, p.currency)}</td>
          <td style="text-align:right">${fmtMoney(it.total_price, p.currency)}</td>
        </tr>
      `).join('');

      return `
        <div class="head">
          <div>
            <h3 style="margin:0">Заказ <span class="pill">${esc(o.order_uid)}</span></h3>
            <div class="muted" style="margin-top:4px">${esc(o.track_number)} • ${esc(o.entry)} • ${fmtDate(o.date_created)}</div>
          </div>
          <div class="pill">Товаров: ${items.length}</div>
        </div>

        <div class="space"></div>

        <div class="grid">
          <section class="section card" style="padding:14px">
            <h4>Доставка</h4>
            <div class="kv">
              <div>Имя</div><div>${esc(d.name)}</div>
              <div>Телефон</div><div>${esc(d.phone)}</div>
              <div>Адрес</div><div>${esc(d.zip)} ${esc(d.city)}, ${esc(d.address)}</div>
              <div>Регион</div><div>${esc(d.region)}</div>
              <div>Email</div><div>${esc(d.email)}</div>
              <div>Служба</div><div>${esc(o.delivery_service)}</div>
            </div>
          </section>

          <section class="section card" style="padding:14px">
            <h4>Оплата</h4>
            <div class="kv">
              <div>Транзакция</div><div>${esc(p.transaction)}</div>
              <div>Банк</div><div>${esc(p.bank)}</div>
              <div>Валюта</div><div>${esc(p.currency || 'USD')}</div>
              <div>Сумма</div><div>${fmtMoney(p.amount, p.currency)}</div>
              <div>Товары</div><div>${fmtMoney(p.goods_total, p.currency)}</div>
              <div>Доставка</div><div>${fmtMoney(p.delivery_cost, p.currency)}</div>
            </div>
          </section>
        </div>

        <div class="space"></div>

        <section class="section">
          <h4>Позиции</h4>
          <div style="overflow:auto">
            <table class="tbl">
              <thead>
                <tr>
                  <th>Название</th>
                  <th>Бренд</th>
                  <th>Трек</th>
                  <th>RID</th>
                  <th style="text-align:right">Скидка</th>
                  <th style="text-align:right">Цена</th>
                  <th style="text-align:right">Итого</th>
                </tr>
              </thead>
              <tbody>${itemsRows || `<tr><td colspan="7" class="muted">Нет позиций</td></tr>`}</tbody>
            </table>
          </div>

          <div class="totals">
            <div class="box">
              <div class="row"><span>Сумма товаров</span><strong>${fmtMoney(itemsTotal, p.currency)}</strong></div>
              <div class="row"><span>Доставка</span><strong>${fmtMoney(deliveryCost, p.currency)}</strong></div>
              <div class="row total"><span>Итого к оплате</span><strong>${fmtMoney(grand, p.currency)}</strong></div>
            </div>
          </div>
        </section>
      `;
    }

    // автозаполнение из URL: ?id=... (order) или ?customer=...
    const params = new URLSearchParams(location.search);
    const presetOrder = params.get('id');
    const presetCustomer = params.get('customer');
    if (presetOrder) { elInput.value = presetOrder; search(); }
    if (presetCustomer) { elCustomer.value = presetCustomer; searchCustomer(); }
  </script>
</body>
</html>
